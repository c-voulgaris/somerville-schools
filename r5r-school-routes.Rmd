---
title: "Generating Bike paths using r5r"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Initial setup

Before you start, you'll want to have a *.pbf file containing
the street network data from OpenStreetMap. In this example, 
I've saved it in a directory called `osm-network`.

You'll also need to have Java SE Development Kit 21 installed 
on your computer. You can download it for free from 
[Oracle](https://docs.oracle.com/en/java/javase/21/install/index.html){target="_blank"}

Before you load the r5r package, you should run this line to allocate
enough memory to Java:

```{r}
options(java.parameters = '-Xmx2G')
```

Now you should load the following libraries (install any that you 
don't already have):

```{r, message=FALSE}
library(r5r)
library(tidyverse)
library(sf)
library(here)
```

## Load data

Your trip origins will be (simulated) student residences. They need
to be in the WGS 84 coordinate reference system and they need to have
a variable called `id` (that has to be its name) with unique identifiers. 

```{r, results='hide'}
brown_students <- here("Cities",
                       "brown",
                       "Data",
                       "brown-students.geojson") |>
  st_read() |>
  st_transform("WGS84")

brown_students <- brown_students |>
  mutate(id = seq(1:nrow(brown_students)))
```

Your trip destinations will be one of the school entrances, and the same
requirements apply.

```{r, results='hide'}
brown_entrance <- here("Cities",
                       "brown",
                       "Data",
                       "brown.geojson") |>
  st_read() |>
  st_transform("WGS84") |>
  filter(name == "Willow Ave Entrance") |>
  mutate(id = 1)
```

For visualization, we can also load a line layer for the street network.

```{r, results='hide'}
streets <- here("Cities",
                "brown",
                "data",
                "network.geojson") |>
  st_read()
```


## Start the R5 core

You'll need to set up the R5 core, specifying the directory
containing the OpenStreetMap network.

```{r, message=FALSE}
my_core <- here("osm-network") |>
  setup_r5()
```

## Generate travel time matrix

Now we can generate the bike path from each origin to each destination,
using only the links that R5/Conveyal have classified as LTS 1 
(based on tags available in the OpenStreetMap data), or using any
available links (LTS 1 through 4).

Once you're done with this part, you should stop the R5 core.

```{r, message=FALSE, warning=FALSE}
LTS_1_paths <- detailed_itineraries(my_core,
                                    origins = brown_students,
                                    destinations = brown_entrance,
                                    mode = "BICYCLE",
                                    max_lts = 1)

LTS_4_paths <- detailed_itineraries(my_core,
                                    origins = brown_students,
                                    destinations = brown_entrance,
                                    mode = "BICYCLE",
                                    max_lts = 4)

stop_r5()
```



## Visualize the result

We can get a quick look at the result using ggplot. 

Here are the shortest paths along the LTS 1 network.

```{r}
ggplot(streets) +
  geom_sf(color = "gray90") +
  geom_sf(data = LTS_1_paths,
          size = 2,
          alpha = 0.1,
          color = "blue") +
  theme_void()
```

And here are the shortest paths along the entire network.

```{r}
ggplot(streets) +
  geom_sf(color = "gray90") +
  geom_sf(data = LTS_4_paths,
          size = 2,
          alpha = 0.1,
          color = "red") +
  theme_void()
```


## Exporting results

We can export these paths for further analysis using other GIS software.

```{r, eval=FALSE}
st_write(LTS_1_paths,
         here("Cities",
              "brown",
              "LTS-1-bike-routes.geojson"))

st_write(LTS_4_paths,
         here("Cities",
              "brown",
              "LTS-4-bike-routes.geojson"))
```

